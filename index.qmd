---
title: '`glitter` makes SPARQL'
subtitle: '`glitter`, un package R pour explorer et collecter des donnÃ©es du web sÃ©mantique'
author: "Lise Vaudor, MaÃ«lle Salmon"
institute: "MeetUp Rladies, 14 novembre 2023"
date: "21/06/2023"
format: 
  revealjs:
    auto-stretch: false
    embed-resources: true
    df-print: kable
    scrollable: true
    logo: img/logo_small.png
    css:
     styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
library(glitter)
library(tidyverse)
library(kableExtra)
library(stringr)
 show=function(dt){
   dt %>% 
     as.data.frame() %>% 
     kable() %>% 
     kable_styling(bootstrap_options = c("hover","condensed"),
                 full_width = F,
                 position = "float_left",
                 font_size = 10)
   }
```

## Projet RECIT

![](img/im_Rladies_mem_1.jpg){width="1200px"}

-   **Analyste de donnÃ©es** dans un labo de gÃ©ographie (UMR 5600 Environnement Ville SociÃ©tÃ©)

-   RÃ´le **pÃ©dagogique**: aider les collÃ¨gues Ã  **utiliser R** pour leurs analyses/valorisation (blog[ğŸ”—](http://perso.ens-lyon.fr/lise.vaudor/))

-   Travail d'**appui Ã  la recherche** â¡ dÃ©veloppement d'outils d'analyse, recueil de donnÃ©es du web (API, web-scraping...)

## Projet RECIT

![](img/im_Rladies_mem_1.jpg){width="1200px"}

-   IntÃ©rÃªt pour les **donnÃ©es du web** (rÃ©seaux sociaux, projet Wikimedia)

-   DÃ©couverte du **web des donnÃ©es** (LOD: Linked Open Data) via les Wikidata

## Projet RECIT

![](img/im_Rladies_mem_2.jpg){width="1200px"}

**Projet Ã©mergent ENS: RECIT**:

**R** pour l'**E**xploration et la **C**ollecte **I**ntÃ©grÃ©e de **T**riplets de donnÃ©es

â¡ï¸ ğŸ’° 20 000 euros sur 4 ans

## Projet RECIT

<div>

![](img/im_Rladies_mem_3.jpg){width="1200px"}

</div>

Stage M2 **Camille Scheffler** et exploration des Wikidata pour deux cas d'Ã©tudes:

-   Les **jumelages** en Europe et dans le monde (Camille Scheffler, Ninon Briot, ATER ENS de Lyon)
-   Le [**lobbyisme** aux USA](http://geoconfluences.ens-lyon.fr/informations-scientifiques/a-la-une/carte-a-la-une/lieux-de-pouvoir-lobbying-etats-unis) (Camille Scheffler, Florence Nussbaum, MCF ENS de Lyon)

## Web sÃ©mantique, linked open data, web des donnÃ©es

![Â© Camille Scheffler](img/web_des_donnees_cscheffler.png){width="1400px"}

## Web sÃ©mantique et Linked Open Data

ğŸ’¡ **Web sÃ©mantique** Vision du web dans laquelle les donnÃ©es sont structurÃ©es et organisÃ©es pour Ãªtre traitables par des machines â¡ lien Ã©troit aux principes FAIR (Findable Accessible Interoperable Reusable)

ğŸ§±ï¸ **Linked Open Data**: Une rÃ©alisation concrÃ¨te de cette vision, consistant en des donnÃ©es interconnectÃ©es et accessible sur le web. *Web des donnÃ©es*

## Formalisation des Linked Open Data

![Â© Camille Scheffler](img/LOD_principes_cscheffler.png){width="1400px"} [exemple: URI correspondant au film "Marius et Jeannette" sur Wikidata](https://www.wikidata.org/wiki/Q3293881)

## Linked Open Data: : LOD-cloud

[ğŸ”—](http://cas.lod-cloud.net/clouds/lod-cloud.svg)

![](img/lod-cloud.jpeg){height="600px"}

## Projet RECIT

<div>

![](img/im_Rladies_mem_4.jpg){width="1200px"}

</div>

En lien (et en parallÃ¨le) aux cas d'Ã©tudes de Camille, dÃ©but du **dÃ©veloppement du package R `glitter`** en 2021.

## Package glitter: objectifs

![](img/logo_small.png)

ğŸ¯ Promouvoir l'usage (exploration, recueil, analyse) des donnÃ©es du web sÃ©mantique pour les chercheurÂ·seÂ·s et Ã©tudiantÂ·eÂ·s **usagers de R**, en:

-   facilitant l'**Ã©criture** des requÃªtes SPARQL
-   facilitant l'**envoi** des requÃªtes
-   favoriser l'analyse/valorisation ultÃ©rieure dans R

En tant que "**Domain Specific Language**" (DSL), glitter correspond Ã  une *syntaxe* et des *fonctions* plus proches du tidyverse et base R que de SPARQL.

## Projet RECIT

![](img/im_Rladies_mem_5.jpg){width="1200px"}

2022, 2023: presta de ğŸ’ª**MaÃ«lle Salmon**

## Projet RECIT

![](img/im_Rladies_mem_6.jpg)

Le projet prend fin: ğŸ‰ {glitter} est prÃªt Ã  Ãªtre utilisÃ©!! ğŸ‰

## Linked Open Data: difficultÃ©s d'appropriation et de collecte

::: columns
::: {.column width="50%"}
-   ğŸ‘€ ce qu'on apprÃ©hende directement: le web documentaire
-   ğŸ’­ difficultÃ©s liÃ©es Ã  la structure des donnÃ©es en graphes
-   ğŸ”® mÃ©tadonnÃ©es intÃ©grÃ©es aux donnÃ©es
-   ğŸ§ ï¸ transformation en donnÃ©es tabulaires pour analyses
-   â›ï¸ difficultÃ©s de collecte (SPARQL)
:::

::: {.column width="50%"}
![Du graphe de connaissances au tableau de donnÃ©es](img/donnees_en_graphe.png){width="600px"}
:::
:::

## Exemple de requÃªte simple

::: columns
::: {.column width="50%"}
Dans R, sans glitter:

```{r bef_glitter, eval=FALSE}
query <- 'SELECT ?film ?filmLabel WHERE {
?film wdt:P31 wd:Q11424. 
SERVICE wikibase:label{bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en".} } LIMIT 10'

tib <- WikidataQueryServiceR::query_wikidata(query)
```

-   ğŸ–Šï¸ RÃ©daction et envoi de commandes R
-   ğŸ Recueil du tableau de rÃ©sultats en tant qu'objet R
-   ğŸ¯ ChaÃ®ne de traitement reproductible
:::

::: {.column width="50%"}
Dans R, avec glitter:

```{r glitter_no_SPARQL}
tib <- spq_init() %>%
  spq_add("?film wdt:P31 wd:Q11424") %>%
  spq_label(film) %>% 
  spq_head(n=10) %>% 
  spq_perform() 
```

```{r show_result_init, echo=FALSE}
tib
```
:::
:::

## 

```{r steps, echo=FALSE}
query <- spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc") %>%            
  spq_add("?loc wdt:P625 ?coords") %>%  
  spq_add("?film wdt:P3383 ?image") %>% 
  spq_add("?film wdt:P921 ?subject", .required=FALSE) %>%          
  spq_add("?film wdt:P577 ?date") %>%   
  spq_label(film,loc,subject) %>% 
  spq_mutate(year=year(date)) %>%       
  spq_select(-date) 

steps=sequins::plot_query(query,show_step=TRUE, label=TRUE)
```

```{r show_step1, echo=FALSE}
steps[[1]]
```

```{r step1}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424")
```

## 

```{r show_step2, echo=FALSE}
steps[[2]]
```

```{r step2}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc")
```

## 

```{r show_step3, echo=FALSE}
steps[[3]]
```

```{r step3}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc") %>%            
  spq_add("?loc wdt:P625 ?coords") 
```

## 

```{r show_step4, echo=FALSE}
steps[[4]]
```

```{r step4}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc") %>%            
  spq_add("?loc wdt:P625 ?coords") %>%  
  spq_add("?film wdt:P3383 ?image") 
```

## 

```{r show_step5, echo=FALSE}
steps[[5]]
```

```{r steps5}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc") %>%            
  spq_add("?loc wdt:P625 ?coords") %>%  
  spq_add("?film wdt:P3383 ?image") %>% 
  spq_add("?film wdt:P921 ?subject", .required=FALSE) 
```

## 

```{r, echo=FALSE}
steps[[6]]
```

```{r step6}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc") %>%            
  spq_add("?loc wdt:P625 ?coords") %>%  
  spq_add("?film wdt:P3383 ?image") %>% 
  spq_add("?film wdt:P921 ?subject", .required=FALSE) %>%          
  spq_add("?film wdt:P577 ?date") 
```

## 

```{r show_step7, echo=FALSE}
steps[[9]]
```

```{r step7}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc") %>%            
  spq_add("?loc wdt:P625 ?coords") %>%  
  spq_add("?film wdt:P3383 ?image") %>% 
  spq_add("?film wdt:P921 ?subject", .required=FALSE) %>%          
  spq_add("?film wdt:P577 ?date") %>%   
  spq_label(film,loc,subject) 
```

## DonnÃ©es enrichies

```{r film_query}
query=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P840 ?loc") %>%            
  spq_add("?loc wdt:P625 ?coords") %>%  
  spq_add("?film wdt:P3383 ?image") %>% 
  spq_add("?film wdt:P921 ?subject", .required=FALSE) %>%          
  spq_add("?film wdt:P577 ?date") %>%   
  spq_label(film,loc,subject) %>% 
  spq_mutate(year=year(date)) %>% 
  spq_group_by(film,film_label,loc,loc_label,coords,image) %>%
  spq_summarise(year=min(year),
                subject_label=str_c(unique(subject_label),sep="; ")) 

df_films=spq_perform(query)
```

Cette table comprend `r nrow(df_films)` lignes (films avec localisation narrative, coordonnÃ©es associÃ©es et affiche). Voici les premiÃ¨res:

```{r calc_df_films_show, echo=FALSE}
df_films_show <- df_films %>% 
   select(film_label, loc_label,coords, image,subject_label, year) %>% 
   unique() %>% 
   head()
```

```{r df_films_show}
df_films_show
```

## Carte mondiale des lieux de fiction (films avec affiche)

```{r lf_c, echo=FALSE}
lf_c=df_films %>%  # prÃ©fixe les uri
  select(film,ends_with("_label"),coords,image,year) %>%  # SÃ©lectionne ces variables (dont "...._label") puis
  group_by(film,coords,image,loc_label,film_label) %>%     # Groupe par ces variables puis 
  summarise(subject_label=paste0(unique(subject_label),    # RÃ©sume par groupe: le sujet (sur une seule ligne)   
                                        collapse=", "),  #  ... en sÃ©parant les Ã©lÃ©ments par ", "
            year=min(year),                              #  ... et l'annÃ©e comme minimum des annÃ©es de sortie   
            .groups="drop")                              # DÃ©groupe
```

```{r lf_map, echo=FALSE}
lf_map =lf_c %>%
  #transform_wikidata_coords("coords") %>%
  mutate(popup=glue::glue("<h1>{film_label}</h1>
                           <li>Lieu: {loc_label}</li>
                           <li>AnnÃ©e de sortie: {year}</li>")) %>%
  mutate(popup=case_when(is.na(image)~popup,
                         !is.na(image)~glue::glue("{popup}
                                                  <img src='{image}' height='200'>"))) %>%
  mutate(popup=case_when(is.na(subject_label)~popup,
                         !is.na(subject_label)~glue::glue("{popup}
                                                         <li>ThÃ¨mes: {subject_label}</li>"))) %>% 
  sf::st_as_sf(wkt="coords")
```

```{r build_map_film, echo=FALSE}
library(leaflet) 
# DÃ©finition d'une Ã©chelle colorÃ©e 
# (en fonction de date de sortie) 
pal <- colorNumeric(c("red", "green", "blue"), c(1895,1950,1970,1990,2010,2023)) 
# CrÃ©ation de la carte 
map=leaflet(lf_map) %>% # dÃ©f carte 
  addTiles() %>% # ajout fond de carte
  addCircleMarkers(col=~pal(year),
                   popup = ~popup,
                   clusterOptions = markerClusterOptions()) 
```

```{r show_map, echo=FALSE}
map 
```

## Package glitter: vue d'ensemble

![](img/tidyverse_logo.jpeg){width="50px"} Un package qui suit quelques principes du tidyverse...

-   usage du **pipe %\>%**
-   fonctions Ã  **prÃ©fixe** (ici `spq_`)
-   vise Ã  la **facilitÃ© d'utilisation** (dÃ©composition en Ã©tapes Ã©lÃ©mentaires)
-   **Ã©valuation** tidy (rÃ©fÃ©rence directe aux noms de variables)
-   attention accordÃ©e Ã  la **documentation** (par exemple via des **vignettes**)

## Package glitter: fonctions principales

::: columns
::: {.column width="50%"}
Fonctions de base:

-   spq_init() pour initier une requÃªte
-   spq_add() pour rajouter un motif de triplet
-   spq_perform() pour envoyer la requÃªte
:::

::: {.column width="50%"}
![](img/dplyr_logo.jpeg){width="50px"} Fonctions inspirÃ©es de dplyr :

-   spq_filter()
-   spq_select()
-   spq_arrange()
-   spq_mutate()
-   spq_group_by()
-   spq_summarise()

â¡ï¸ "Where the magic is" (MaÃ«lle)
:::
:::

## Dimension de la requÃªte?

Combien de films dans Wikidata:

```{r req_glob_lf}
tib <- spq_init() %>%                 
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_summarise(n_films=n()) %>%      # RÃ©sume en comptant le nombre de films puis
  spq_perform()                       # Envoie la requÃªte
```

```{r req_glob_lf_show , echo=FALSE}
tib
```

## Dimensionnement des requÃªtes

::: columns
::: {.column width="50%"}
Temps de rÃ©ponse du serveur limitÃ© par un paramÃ¨tre de Time out:

-   Wikidata Query Service : 60s
-   client (par ex. glitter): 300s

Pour **film**:

```{r dim_req1}
df=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_summarise(n=n()) %>% 
  spq_perform()
df
```

-   Wikidata Query Service : âŒ
-   client (par ex. glitter): âœ…ï¸
:::

::: {.column width="50%"}
![](img/taille_requete_1.png)
:::
:::

## Dimensionnement des requÃªtes

::: columns
::: {.column width="50%"}
Temps de rÃ©ponse du serveur limitÃ© par un paramÃ¨tre de Time out:

-   Wikidata Query Service : 60s
-   client (par ex. glitter): 300s

Pour **film**, **date**:

```{r dim_req2}
df=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>%  
  spq_add("?film wdt:P577 ?date") %>% 
  spq_summarise(n=n()) %>% 
  spq_perform()
df
```

-   Wikidata Query Service : âŒ
-   client (par ex. glitter): âŒï¸
:::

::: {.column width="50%"}
![](img/taille_requete_2.png)
:::
:::

## Dimensionnement des requÃªtes

::: columns
::: {.column width="50%"}
Temps de rÃ©ponse du serveur limitÃ© par un paramÃ¨tre de Time out:

-   Wikidata Query Service : 60s
-   client (par ex. glitter): 300s

Pour **film**, **date**, **image**:

```{r dim_req3}
df=spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P577 ?date") %>% 
  spq_add("?film wdt:P3383 ?image") %>% 
  spq_summarise(n=n()) %>% 
  spq_perform()
df
```

-   Wikidata Query Service : âœ…ï¸
-   client (par ex. glitter): âœ…ï¸
:::

::: {.column width="50%"}
![](img/taille_requete_3.png)
:::
:::

## Combinaison de requÃªtes

Si on voulait par exemple rÃ©cupÃ©rer le **genre** de film (comÃ©die, drame, film d'aventure, etc.) et les **acteurs et actrices**:

```{r genre_and_actor}
spq_init() %>%                     
  spq_add("?film wdt:P31 wd:Q11424") %>% 
  spq_add("?film wdt:P136 ?genre") %>%
  spq_add("?film wdt:P161 ?actor",.required=FALSE) %>% 
  spq_tally() %>% 
  spq_perform()
```

## Combinaison de requÃªtes

```{r combi_queries}
get_genre_and_actors=function(film_id){
  film_id=paste0("<",film_id,">")
  result=spq_init() %>%
      spq_set(film= film_id) %>%
      spq_add("?film wdt:P136 ?genre") %>%
      spq_add("?film wdt:P161 ?actor",.required=FALSE) %>%
      spq_label(genre, actor) %>%
      spq_select(-film) %>%
      spq_perform()
  return(result)
}

tib_genre_actors=df_films %>%
   head() %>% 
   mutate(data=purrr::map(film,get_genre_and_actors)) %>% 
   unnest(cols=data)
```

```{r show_tib_genre_actors}
tib_genre_actors %>%
  select(film_label,genre_label,actor_label)
```

## GÃ©nÃ©ralisation Ã  l'usage d'autres endpoints

![](img/logos_endpoints.png){width="1000px"} Exemple de requÃªte sur le SPARQL endpoint de dbpedia:

```{r dbpedia}
tib <- spq_init("dbpedia") %>%
  spq_add("?person dbo:birthPlace ?place") %>% # ?personne est nÃ©e Ã  ?place
  spq_add("?person dbo:profession ?job") %>%   # ?personne a pour profession ?job
  spq_add("?job rdfs:label ?job_label") %>%     # ?job a pour Ã©tiquette ?job_label
  spq_filter(lang(job_label)=="en") %>%         # Filtre pour ne garder que les Ã©tiquettes en anglais
  spq_add("?place rdfs:label 'Lyon'@en") %>%   # ?place a pour Ã©tiquette 'Lyon' (en anglais)
  spq_head(10) %>%
  spq_perform()                       # Envoie sur le SPARQL endpoint de DBPEDIA
```

```{r show_dbpedia,  echo=FALSE}
tib
```

## GÃ©nÃ©ralisation Ã  d'autres endpoints: hal

```{r}
query_hal <- spq_init("hal") %>%
  spq_add("?doc dcterms:creator ?createur") %>%
  spq_add("?createur hal:structure ?affiliation") %>%
  spq_add("?createur hal:person ?personne") %>%
  spq_add("?personne foaf:name 'Lise Vaudor'") %>% 
  spq_add("?doc dcterms:type ?type") %>%
  spq_label(type, .languages = "fr") %>%
  spq_add("?doc dcterms:bibliographicCitation ?citation") %>%
  spq_add("?doc dcterms:issued ?date") %>%
  spq_mutate(date = str_sub(as.character(date), 1, 4)) %>%
  spq_group_by(citation, type_label, date) %>%
  spq_summarise(affiliation = str_c(affiliation, sep = ", ")) 

sequins::plot_query(query_hal)
```

```{r query_hal_perform}
docs_lv_hal=query_hal %>%
  spq_perform()
docs_lv_hal
```

## PrÃ©fixes usuels

Le package glitter fournit une **liste de prÃ©fixes usuels** pour allÃ©ger l'Ã©criture de la requÃªte...

```{r show_usual_prefixes }
usual_prefixes
```

## GÃ©nÃ©ralisation: endpoints "usuels"

... et il fournit une liste d'endpoints usuels:

```{r show_usual_endpoints }
usual_endpoints
```

## Utiliser les LOD pour recueillir et complÃ©ter des donnÃ©es

Exemples pratiques d'utilisation:

-   ğŸŒ» donnÃ©es **botaniques** â¡ï¸ associer une photo et un nom vernaculaire Ã  un nom d'espÃ¨ce en latin
-   ğŸ“œ corpus de **communiquÃ©s de presse du MinistÃ¨re de l'Ecologie** â¡ï¸ rÃ©cupÃ©rer le nom du ministre, avec les dates de dÃ©but et de fin de son mandat.
-   ğŸ™ï¸ lien entre **grandes villes et plaines alluviales** â¡ï¸ rÃ©cupÃ©rer les populations des grandes villes et leurs coordonnÃ©es, associer Ã  une riviÃ¨re
-   ğŸŒ **carte du monde** basÃ©e sur un shapefile avec des codes pays â¡ï¸ rÃ©cupÃ©rer les noms de pays, le nom et les coordonnÃ©es de leur capitales

â¡ï¸ Richesse thÃ©matique pour (par exemple) la construction de **jeux de donnÃ©es pÃ©dagogiques**

## Et maintenant?

![](img/chantier.png){width="100px"} Chantier fini: on remballe!

ğŸ“£ Retours utilisateurs bienvenus

![](img/github_logo.png){width="25px"} Package installable et modifiable ici <https://github.com/lvaudor/glitter>.

ğŸ“„ https://lvaudor.github.io/glitter/

ğŸ§  Cas d'usages: Ã  vous de jouer!

ğŸ™ Merci pour votre attention!

# ANNEXES

## Sequins

https://github.com/lvaudor/sequins

![](img/hex-sequins_small.png)

## Projet: Objectifs

![](img/RECIT.png)
